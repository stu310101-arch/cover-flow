<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å­¸ç¿’ç­†è¨˜åº« - å­¸æ¸¬è‡ªç„¶ç§‘è¦–è¦ºåŒ–ç­†è¨˜</title>
  <style>
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      height: 100%;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", sans-serif;
      background: radial-gradient(circle at top, #e5e7eb, #f1f5f9 55%, #e5e7eb 100%);
      color: #0f172a;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    a {
      color: inherit;
      text-decoration: none;
    }

    button {
      border: none;
      background: none;
      cursor: pointer;
      font-family: inherit;
    }

    main {
      flex: 1;
      display: flex;
      align-items: stretch;
      justify-content: center;
      padding: 16px;
    }

    /* Header */
    .app-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 18px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.6);
      background: linear-gradient(to right, #0f172a, #020617);
      color: #e5e7eb;
      position: sticky;
      top: 0;
      z-index: 50;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .brand-mark {
      width: 30px;
      height: 30px;
      border-radius: 999px;
      background: conic-gradient(from 210deg, #38bdf8, #6366f1, #f97316, #22c55e, #38bdf8);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow:
        0 0 0 1px rgba(15, 23, 42, 0.9),
        0 10px 20px rgba(15, 23, 42, 0.9);
    }

    .brand-mark-inner {
      width: 18px;
      height: 18px;
      border-radius: 6px;
      background: radial-gradient(circle at top, #f9fafb, #020617);
      border: 2px solid rgba(15, 23, 42, 0.96);
    }

    .brand-title {
      font-size: 16px;
      font-weight: 600;
      letter-spacing: 0.12em;
    }

    .brand-subtitle {
      font-size: 11px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: #9ca3af;
    }

    .auth-panel {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
    }

    .auth-user-label {
      color: #cbd5f5;
      max-width: 200px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .auth-btn {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.9);
      background: rgba(15, 23, 42, 0.9);
      color: #e5e7eb;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: background 0.16s ease, transform 0.1s ease, border-color 0.16s ease;
    }

    .auth-btn:hover:not(:disabled) {
      background: rgba(15, 23, 42, 1);
      border-color: #e5e7eb;
      transform: translateY(-1px);
    }

    .auth-btn:disabled {
      opacity: 0.5;
      cursor: default;
    }

    /* Views */
    .view {
      width: 100%;
      max-width: 1100px;
      display: none;
    }

    .view.active {
      display: block;
    }

    /* Home view */
    .home-container {
      min-height: calc(100vh - 64px);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    .home-title {
      text-align: center;
      margin-bottom: 28px;
    }

    .home-title h1 {
      font-size: 32px;
      font-weight: 800;
      letter-spacing: 0.16em;
      color: #111827;
      margin-bottom: 4px;
    }

    .home-title p {
      font-size: 14px;
      color: #6b7280;
    }

    .search-area {
      position: relative;
      width: 100%;
      max-width: 420px;
      margin-bottom: 32px;
    }

    .search-input-wrapper {
      position: relative;
    }

    .search-input {
      width: 100%;
      padding: 10px 14px 10px 34px;
      border-radius: 999px;
      border: 2px solid #e5e7eb;
      font-size: 14px;
      outline: none;
      box-shadow: 0 4px 10px rgba(148, 163, 184, 0.3);
    }

    .search-input:focus {
      border-color: #4f46e5;
      box-shadow: 0 0 0 1px rgba(79, 70, 229, 0.4), 0 10px 25px rgba(148, 163, 184, 0.4);
    }

    .search-icon {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 14px;
      color: #9ca3af;
    }

    .search-clear-btn {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 14px;
      color: #9ca3af;
      background: none;
      border: none;
      cursor: pointer;
    }

    .search-results {
      position: absolute;
      left: 0;
      right: 0;
      margin-top: 6px;
      background: #ffffff;
      border-radius: 14px;
      box-shadow: 0 16px 40px rgba(15, 23, 42, 0.18);
      border: 1px solid #e5e7eb;
      max-height: 260px;
      overflow-y: auto;
      display: none;
      z-index: 20;
    }

    .search-result-item {
      padding: 8px 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      cursor: pointer;
      border-bottom: 1px solid #f3f4f6;
    }

    .search-result-item:last-child {
      border-bottom: none;
    }

    .search-result-item:hover {
      background: #eef2ff;
    }

    .search-result-main {
      display: flex;
      flex-direction: column;
    }

    .search-result-title {
      font-weight: 600;
      color: #111827;
    }

    .search-result-subject {
      font-size: 11px;
      color: #6b7280;
    }

    .search-result-empty {
      padding: 10px 12px;
      font-size: 13px;
      color: #9ca3af;
      text-align: center;
    }

    .subject-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 150px));
      gap: 18px;
      justify-content: center;
    }

    @media (max-width: 520px) {
      .subject-grid {
        grid-template-columns: repeat(2, minmax(0, 130px));
      }
    }

    .subject-card {
      position: relative;
      width: 150px;
      height: 150px;
      border-radius: 999px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #ffffff;
      box-shadow: 0 16px 40px rgba(15, 23, 42, 0.25);
      transition: transform 0.18s ease, box-shadow 0.18s ease, filter 0.18s ease;
      overflow: hidden;
    }

    .subject-card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top, rgba(249, 250, 251, 0.28), transparent 55%);
      opacity: 0;
      transition: opacity 0.18s ease;
    }

    .subject-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 22px 52px rgba(15, 23, 42, 0.32);
      filter: brightness(1.03);
    }

    .subject-card:hover::before {
      opacity: 1;
    }

    .subject-abbr {
      font-size: 24px;
      font-weight: 700;
      letter-spacing: 0.2em;
    }

    .subject-name {
      margin-top: 4px;
      font-weight: 600;
      letter-spacing: 0.16em;
      font-size: 12px;
    }

    .subject-caption {
      font-size: 11px;
      opacity: 0.9;
      margin-top: 2px;
      padding: 0 12px;
      text-align: center;
    }

    .subject-phy { background: linear-gradient(135deg, #38bdf8, #1d4ed8); }
    .subject-che { background: linear-gradient(135deg, #a855f7, #4f46e5); }
    .subject-bio { background: linear-gradient(135deg, #22c55e, #16a34a); }
    .subject-ear { background: linear-gradient(135deg, #f97316, #ea580c); }

    /* Book view */
    .book-container {
      margin: 12px auto;
      max-width: 1000px;
      background: radial-gradient(circle at top, #f9fafb, #f3f4f6 55%, #e5e7eb 100%);
      border-radius: 20px;
      box-shadow: 0 24px 60px rgba(15, 23, 42, 0.32);
      padding: 16px 18px 18px;
    }

    .book-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 14px;
    }

    .book-back-btn {
      font-size: 13px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #ffffff;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      color: #374151;
      transition: background 0.16s ease, transform 0.1s ease;
    }

    .book-back-btn:hover {
      background: #f9fafb;
      transform: translateY(-1px);
    }

    .book-subject-title {
      font-size: 18px;
      font-weight: 700;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: #111827;
    }

    .book-header-spacer {
      width: 60px;
    }

    .book-pages {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0;
      border-radius: 14px;
      overflow: hidden;
      border: 1px solid #e5e7eb;
      background: #fefcf7;
    }

    @media (max-width: 800px) {
      .book-pages {
        grid-template-columns: 1fr;
      }

      .book-header-spacer {
        display: none;
      }
    }

    .book-page {
      padding: 14px 16px 16px;
      position: relative;
    }

    .book-page::before {
      content: "";
      position: absolute;
      inset: 0;
      background-image: linear-gradient(rgba(148, 163, 184, 0.16) 1px, transparent 1px);
      background-size: 100% 22px;
      opacity: 0.55;
      pointer-events: none;
    }

    .book-page-inner {
      position: relative;
      z-index: 1;
    }

    .book-page-title {
      font-size: 12px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: #9ca3af;
      margin-bottom: 6px;
    }

    .book-list {
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 13px;
    }

    .book-list-item {
      padding: 4px 8px;
      border-bottom: 1px dashed #d1d5db;
      cursor: pointer;
      display: flex;
      gap: 8px;
      align-items: baseline;
      transition: background 0.12s ease, border-color 0.12s ease, transform 0.08s ease;
    }

    .book-list-item:hover {
      background: rgba(219, 234, 254, 0.8);
      border-bottom-style: solid;
      border-bottom-color: #60a5fa;
      transform: translateY(-1px);
    }

    .book-list-index {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
      color: #9ca3af;
      min-width: 26px;
    }

    .book-list-title {
      color: #111827;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .book-list-empty {
      padding: 10px 8px;
      font-size: 13px;
      color: #9ca3af;
    }

    .book-footer-hint {
      margin-top: 8px;
      font-size: 11px;
      color: #6b7280;
      text-align: right;
    }

    /* Note view */
    .note-wrapper {
      margin: 12px auto 16px;
      max-width: 900px;
      background: #f9fafb;
      border-radius: 18px;
      box-shadow: 0 24px 60px rgba(15, 23, 42, 0.32);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .note-header {
      background: linear-gradient(to right, #4f46e5, #7c3aed);
      color: #f9fafb;
      padding: 10px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .note-back-btn {
      font-size: 13px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(191, 219, 254, 0.9);
      background: rgba(15, 23, 42, 0.12);
      color: #e5e7eb;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: background 0.16s ease, transform 0.1s ease;
    }

    .note-back-btn:hover {
      background: rgba(15, 23, 42, 0.24);
      transform: translateY(-1px);
    }

    .note-breadcrumb {
      font-size: 12px;
      max-width: 420px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .note-subject-tag {
      font-size: 10px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(219, 234, 254, 0.9);
      background: rgba(15, 23, 42, 0.08);
    }

    .note-body {
      padding: 16px 18px 18px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .note-title {
      font-size: 22px;
      font-weight: 700;
      color: #111827;
      border-bottom: 1px solid #e5e7eb;
      padding-bottom: 8px;
      margin-bottom: 4px;
    }

    .note-sections {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.2fr);
      gap: 16px;
    }

    @media (max-width: 800px) {
      .note-sections {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .section-card {
      background: #ffffff;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      padding: 12px 14px 14px;
      font-size: 13px;
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 6px;
    }

    .section-title {
      font-size: 13px;
      font-weight: 700;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: #4b5563;
    }

    .section-subtitle {
      font-size: 11px;
      color: #9ca3af;
    }

    .hint-placeholder {
      font-size: 13px;
      color: #6b7280;
      line-height: 1.6;
      white-space: pre-wrap;
    }

    .user-note-header-line {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .note-status-text {
      font-size: 11px;
      color: #6b7280;
    }

    .note-textarea {
      width: 100%;
      min-height: 140px;
      resize: vertical;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      font-size: 13px;
      font-family: inherit;
      outline: none;
      line-height: 1.5;
      background: #f9fafb;
    }

    .note-textarea:focus {
      border-color: #4f46e5;
      box-shadow: 0 0 0 1px rgba(79, 70, 229, 0.3);
      background: #ffffff;
    }

    .note-textarea:disabled {
      background: #f3f4f6;
      color: #9ca3af;
    }

    .note-actions {
      margin-top: 8px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      font-size: 12px;
      align-items: center;
    }

    .note-save-btn {
      padding: 6px 12px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(to right, #4f46e5, #6366f1);
      color: #f9fafb;
      font-size: 12px;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      box-shadow: 0 10px 30px rgba(79, 70, 229, 0.35);
      transition: transform 0.1s ease, box-shadow 0.1s ease, filter 0.1s ease;
    }

    .note-save-btn:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 16px 40px rgba(79, 70, 229, 0.45);
      filter: brightness(1.04);
    }

    .note-save-btn:disabled {
      opacity: 0.6;
      cursor: default;
      box-shadow: none;
    }

    .note-footer-line {
      margin-top: 4px;
      font-size: 11px;
      color: #9ca3af;
      text-align: right;
    }

    footer {
      padding: 10px 16px 12px;
      font-size: 11px;
      color: #9ca3af;
      text-align: center;
    }
  </style>
</head>
<body>
<header class="app-header">
  <div class="brand">
    <div class="brand-mark"><div class="brand-mark-inner"></div></div>
    <div>
      <div class="brand-title">å­¸ç¿’ç­†è¨˜åº«</div>
      <div class="brand-subtitle">Visual Science Notes</div>
    </div>
  </div>
  <div class="auth-panel">
    <span id="authUserLabel" class="auth-user-label">å°šæœªç™»å…¥</span>
    <button type="button" id="loginBtn" class="auth-btn">ç™»å…¥</button>
    <button type="button" id="logoutBtn" class="auth-btn" style="display:none;">ç™»å‡º</button>
  </div>
</header>

<main>
  <!-- View: Home -->
  <section id="view-home" class="view active">
    <div class="home-container">
      <div class="home-title">
        <h1>å­¸ç¿’ç­†è¨˜åº«</h1>
        <p>é¸æ“‡ä¸€å€‹ç§‘ç›®ï¼Œæˆ–ç›´æ¥æœå°‹å–®å…ƒåç¨±</p>
      </div>

      <div id="searchArea" class="search-area">
        <div class="search-input-wrapper">
          <span class="search-icon">ğŸ”</span>
          <input id="searchInput" class="search-input" type="search" placeholder="æœå°‹å–®å…ƒã€é—œéµå­—...">
          <button id="searchClearBtn" class="search-clear-btn" title="æ¸…é™¤æœå°‹">âœ•</button>
        </div>
        <div id="searchResults" class="search-results"></div>
      </div>

      <div class="subject-grid">
        <button type="button" class="subject-card subject-phy" data-subject="physics">
          <div class="subject-abbr">PHY</div>
          <div class="subject-name">ç‰©ç†</div>
          <div class="subject-caption">å¾åŠ›èˆ‡é‹å‹•é–‹å§‹ï¼Œç†è§£ä¸–ç•Œè¦å¾‹ã€‚</div>
        </button>
        <button type="button" class="subject-card subject-che" data-subject="chemistry">
          <div class="subject-abbr">CHE</div>
          <div class="subject-name">åŒ–å­¸</div>
          <div class="subject-caption">è®“å…ƒç´ èˆ‡åæ‡‰åœ¨è¦–è¦ºä¸­å‹•èµ·ä¾†ã€‚</div>
        </button>
        <button type="button" class="subject-card subject-bio" data-subject="biology">
          <div class="subject-abbr">BIO</div>
          <div class="subject-name">ç”Ÿç‰©</div>
          <div class="subject-caption">å¾ç´°èƒåˆ°ç”Ÿæ…‹ï¼Œä¸€è·¯ä¸²èµ·ç”Ÿå‘½æ•…äº‹ã€‚</div>
        </button>
        <button type="button" class="subject-card subject-ear" data-subject="earth_science">
          <div class="subject-abbr">EAR</div>
          <div class="subject-name">åœ°ç§‘</div>
          <div class="subject-caption">è®€æ‡‚å¤©ç©ºã€å¤§åœ°èˆ‡æµ·æ´‹çš„è¨Šè™Ÿã€‚</div>
        </button>
      </div>
    </div>
  </section>

  <!-- View: Book / subject notebook -->
  <section id="view-book" class="view">
    <div class="book-container">
      <div class="book-header">
        <button type="button" id="bookBackBtn" class="book-back-btn">â† è¿”å›å¤§å»³</button>
        <div id="bookSubjectTitle" class="book-subject-title">ç§‘ç›®ç­†è¨˜æœ¬</div>
        <div class="book-header-spacer"></div>
      </div>
      <div class="book-pages">
        <div class="book-page">
          <div class="book-page-inner">
            <div class="book-page-title">å·¦é ç›®éŒ„</div>
            <ul id="bookListLeft" class="book-list"></ul>
          </div>
        </div>
        <div class="book-page">
          <div class="book-page-inner">
            <div class="book-page-title">å³é ç›®éŒ„</div>
            <ul id="bookListRight" class="book-list"></ul>
          </div>
        </div>
      </div>
      <div class="book-footer-hint">æç¤ºï¼šé»æ“Šä»»ä¸€å–®å…ƒæ¨™é¡Œé€²å…¥è©³ç´°é é¢èˆ‡å€‹äººç­†è¨˜ã€‚</div>
    </div>
  </section>

  <!-- View: Note / unit page -->
  <section id="view-note" class="view">
    <div class="note-wrapper">
      <div class="note-header">
        <button type="button" id="noteBackBtn" class="note-back-btn">â† è¿”å›ç›®éŒ„</button>
        <div id="noteBreadcrumb" class="note-breadcrumb"></div>
        <div id="noteSubjectTag" class="note-subject-tag"></div>
      </div>
      <div class="note-body">
        <div id="noteUnitTitle" class="note-title">å–®å…ƒæ¨™é¡Œ</div>
        <div class="note-sections">
          <!-- å°æé»ï¼ˆåŸæœ¬çš„éœæ…‹ç­†è¨˜å…§å®¹ï¼Œä¹‹å¾Œä½ å†æä¾›ï¼‰ -->
          <section class="section-card">
            <div class="section-header">
              <div class="section-title">å°æé»</div>
              <div class="section-subtitle">ä½œè€…æ•´ç†ï¼Œä½¿ç”¨è€…ç„¡æ³•ç·¨è¼¯</div>
            </div>
            <div id="hintContent" class="hint-placeholder">
              é€™è£¡ä¹‹å¾Œæœƒæ”¾æœ¬å–®å…ƒçš„å°æé»ï¼ˆé—œéµè§€å¿µã€æ˜“éŒ¯é»ç­‰ï¼‰ï¼Œç”±ä½ æä¾›æ–‡å­—å…§å®¹ã€‚
            </div>
          </section>

          <!-- å€‹äººé›²ç«¯ç­†è¨˜ -->
          <section class="section-card">
            <div class="user-note-header-line">
              <div class="section-title">æˆ‘çš„ç­†è¨˜</div>
              <div id="noteStatusText" class="note-status-text">è«‹å…ˆç™»å…¥ä»¥ç·¨è¼¯ä¸¦å„²å­˜ç­†è¨˜ã€‚</div>
            </div>
            <textarea id="noteTextarea" class="note-textarea" placeholder="ç™»å…¥å¾Œå³å¯åœ¨é€™è£¡ç‚ºæœ¬å–®å…ƒç•™ä¸‹è‡ªå·±çš„æ•´ç†èˆ‡å¿ƒå¾—ã€‚" disabled></textarea>
            <div class="note-actions">
              <button type="button" id="noteSaveBtn" class="note-save-btn" disabled>ğŸ’¾ å„²å­˜ç­†è¨˜</button>
            </div>
            <div id="noteFooterInfo" class="note-footer-line"></div>
          </section>
        </div>
      </div>
    </div>
  </section>
</main>

<footer>
  å­¸æ¸¬è‡ªç„¶ç§‘è¦–è¦ºåŒ–è¤‡ç¿’ç­†è¨˜ç¶² Â· å–®æª” HTML ç‰ˆæœ¬ Â· Firebase ç™»å…¥ï¼‹å€‹äººé›²ç«¯ç­†è¨˜
</footer>

<!-- Firebase SDKï¼ˆè‹¥è¦å•Ÿç”¨ç™»å…¥èˆ‡é›²ç«¯ç­†è¨˜ï¼Œè«‹å…ˆåœ¨ä¸‹æ–¹å¡«å…¥è‡ªå·±çš„ firebaseConfigï¼‰ -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
  // ===== 1. æœ¬åœ°è³‡æ–™ï¼šç§‘ç›®èˆ‡å–®å…ƒï¼ˆåªä¿ç•™æ¨™é¡Œï¼Œç­†è¨˜å…§å®¹ä¹‹å¾Œä½ å†æ±ºå®šï¼‰ =====
  const SUBJECTS = {
    physics: {
      id: "physics",
      name: "ç‰©ç†",
      colorClass: "subject-phy",
      units: [
        { id: "p1", title: "ç‰›é “ç¬¬ä¸€é‹å‹•å®šå¾‹" },
        { id: "p2", title: "ç‰›é “ç¬¬äºŒé‹å‹•å®šå¾‹" },
        { id: "p3", title: "ç‰›é “ç¬¬ä¸‰é‹å‹•å®šå¾‹" },
        { id: "p4", title: "ç†±åŠ›å­¸ç¬¬ä¸€å®šå¾‹" },
        { id: "p5", title: "è¬æœ‰å¼•åŠ›" },
        { id: "p6", title: "å…‰å­¸ï¼šæŠ˜å°„èˆ‡åå°„" },
        { id: "p7", title: "é›»ç£æ„Ÿæ‡‰" },
        { id: "p8", title: "é‡å­åŠ›å­¸åŸºç¤" }
      ]
    },
    chemistry: {
      id: "chemistry",
      name: "åŒ–å­¸",
      colorClass: "subject-che",
      units: [
        { id: "c_periodic", title: "å…ƒç´ é€±æœŸè¡¨" },
        { id: "c1", title: "åŸå­çµæ§‹" },
        { id: "c2", title: "åŒ–å­¸éµçµ" },
        { id: "c3", title: "é…¸é¹¼ä¸­å’Œ" },
        { id: "c4", title: "æ°§åŒ–é‚„åŸåæ‡‰" },
        { id: "c5", title: "æœ‰æ©ŸåŒ–å­¸å°è«–" }
      ]
    },
    biology: {
      id: "biology",
      name: "ç”Ÿç‰©",
      colorClass: "subject-bio",
      units: [
        { id: "b1", title: "ç´°èƒæ§‹é€ " },
        { id: "b2", title: "å…‰åˆä½œç”¨" },
        { id: "b3", title: "éºå‚³å­¸ï¼šå­Ÿå¾·çˆ¾å®šå¾‹" },
        { id: "b4", title: "äººé«”å¾ªç’°ç³»çµ±" },
        { id: "b5", title: "ç¥ç¶“ç³»çµ±" }
      ]
    },
    earth_science: {
      id: "earth_science",
      name: "åœ°ç§‘",
      colorClass: "subject-ear",
      units: [
        { id: "e1", title: "åœ°çƒæ°£é«”èˆ‡å¤§æ°£å±¤" },
        { id: "e2", title: "æ¿å¡Šæ§‹é€ å­¸èªª" },
        { id: "e3", title: "å¤©æ–‡ï¼šå¤ªé™½ç³»" },
        { id: "e4", title: "å²©çŸ³å¾ªç’°" },
        { id: "e5", title: "æ°£è±¡è§€æ¸¬" }
      ]
    }
  };

  // å…¨åŸŸæœå°‹ç´¢å¼•ï¼šåªç”¨å–®å…ƒæ¨™é¡Œèˆ‡ç§‘ç›®åç¨±
  const searchIndex = [];
  Object.keys(SUBJECTS).forEach((key) => {
    const subject = SUBJECTS[key];
    (subject.units || []).forEach((unit) => {
      searchIndex.push({
        subjectId: subject.id,
        subjectName: subject.name,
        unitId: unit.id,
        unitTitle: unit.title
      });
    });
  });

  // ===== 2. UI ç‹€æ…‹ =====
  let currentView = "home";
  let activeSubjectId = null;
  let activeUnitId = null;
  let activeUnitTitle = "";

  // Firebase / Auth ç‹€æ…‹
  let firebaseReady = false;
  let auth = null;
  let db = null;
  let currentUser = null;

  // ===== 3. åŸºç¤ UI åˆ‡æ› =====
  function showView(viewId) {
    currentView = viewId;
    ["view-home", "view-book", "view-note"].forEach((id) => {
      const el = document.getElementById(id);
      if (!el) return;
      if (id === "view-" + viewId) {
        el.classList.add("active");
      } else {
        el.classList.remove("active");
      }
    });
  }

  function openSubject(subjectId) {
    const subject = SUBJECTS[subjectId];
    if (!subject) return;
    activeSubjectId = subjectId;
    activeUnitId = null;
    activeUnitTitle = "";
    renderBook(subject);
    showView("book");
  }

  function openUnit(subjectId, unitId, unitTitle) {
    const subject = SUBJECTS[subjectId];
    if (!subject) return;
    activeSubjectId = subjectId;
    activeUnitId = unitId;
    activeUnitTitle = unitTitle;
    renderNote(subject, unitTitle);
    showView("note");
    updateNoteEditorState();
    if (firebaseReady && currentUser && db) {
      loadUserNote();
    } else {
      const textarea = document.getElementById("noteTextarea");
      if (textarea && !textarea.disabled) {
        textarea.value = "";
      }
    }
  }

  // ===== 4. Home åˆå§‹åŒ–èˆ‡æœå°‹ =====
  function initHome() {
    const subjectButtons = document.querySelectorAll(".subject-card");
    subjectButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const subjectId = btn.getAttribute("data-subject");
        openSubject(subjectId);
      });
    });

    const searchInput = document.getElementById("searchInput");
    const searchClearBtn = document.getElementById("searchClearBtn");
    const searchResultsBox = document.getElementById("searchResults");
    const searchArea = document.getElementById("searchArea");

    if (!searchInput || !searchResultsBox || !searchArea || !searchClearBtn) return;

    function renderSearchResults(query) {
      const q = (query || "").trim().toLowerCase();
      searchResultsBox.innerHTML = "";
      if (!q) {
        searchResultsBox.style.display = "none";
        return;
      }
      const matches = searchIndex.filter((item) =>
        item.unitTitle.toLowerCase().includes(q) ||
        item.subjectName.toLowerCase().includes(q)
      );
      if (!matches.length) {
        const div = document.createElement("div");
        div.className = "search-result-empty";
        div.textContent = "æ‰¾ä¸åˆ°ç›¸é—œå–®å…ƒ";
        searchResultsBox.appendChild(div);
      } else {
        matches.forEach((item) => {
          const row = document.createElement("div");
          row.className = "search-result-item";
          const main = document.createElement("div");
          main.className = "search-result-main";
          const title = document.createElement("div");
          title.className = "search-result-title";
          title.textContent = item.unitTitle;
          const sub = document.createElement("div");
          sub.className = "search-result-subject";
          sub.textContent = item.subjectName;
          main.appendChild(title);
          main.appendChild(sub);
          const arrow = document.createElement("div");
          arrow.textContent = "â†’";
          arrow.style.fontSize = "12px";
          arrow.style.color = "#9ca3af";
          row.appendChild(main);
          row.appendChild(arrow);
          row.addEventListener("click", () => {
            searchInput.value = "";
            searchResultsBox.style.display = "none";
            openUnit(item.subjectId, item.unitId, item.unitTitle);
          });
          searchResultsBox.appendChild(row);
        });
      }
      searchResultsBox.style.display = "block";
    }

    searchInput.addEventListener("input", () => {
      renderSearchResults(searchInput.value);
    });

    searchClearBtn.addEventListener("click", () => {
      searchInput.value = "";
      renderSearchResults("");
      searchInput.focus();
    });

    // é»æ“Šå¤–éƒ¨é—œé–‰æœå°‹çµæœ
    document.addEventListener("click", (e) => {
      if (!searchArea.contains(e.target)) {
        searchResultsBox.style.display = "none";
      }
    });
  }

  // ===== 5. Book (ç§‘ç›®ç›®éŒ„) =====
  function renderBook(subject) {
    const titleEl = document.getElementById("bookSubjectTitle");
    const leftList = document.getElementById("bookListLeft");
    const rightList = document.getElementById("bookListRight");
    if (!titleEl || !leftList || !rightList) return;

    titleEl.textContent = subject.name + " ç­†è¨˜æœ¬";

    leftList.innerHTML = "";
    rightList.innerHTML = "";

    const units = subject.units || [];
    if (!units.length) {
      const li = document.createElement("li");
      li.className = "book-list-empty";
      li.textContent = "æ­¤ç§‘ç›®å‰å°šæœªå»ºç«‹å–®å…ƒã€‚";
      leftList.appendChild(li);
      return;
    }

    const half = Math.ceil(units.length / 2);

    function addUnitRow(listEl, unit, index) {
      const li = document.createElement("li");
      li.className = "book-list-item";
      const idx = document.createElement("span");
      idx.className = "book-list-index";
      idx.textContent = String(index + 1).padStart(2, "0") + ".";
      const title = document.createElement("span");
      title.className = "book-list-title";
      title.textContent = unit.title;
      li.appendChild(idx);
      li.appendChild(title);
      li.addEventListener("click", () => {
        openUnit(subject.id, unit.id, unit.title);
      });
      listEl.appendChild(li);
    }

    units.slice(0, half).forEach((unit, i) => addUnitRow(leftList, unit, i));
    units.slice(half).forEach((unit, i) => addUnitRow(rightList, unit, half + i));
  }

  function initBookNav() {
    const backBtn = document.getElementById("bookBackBtn");
    if (backBtn) {
      backBtn.addEventListener("click", () => {
        showView("home");
      });
    }
  }

  // ===== 6. Note (å–®å…ƒé  + é›²ç«¯ç­†è¨˜) =====
  function renderNote(subject, unitTitle) {
    const breadcrumbEl = document.getElementById("noteBreadcrumb");
    const subjectTagEl = document.getElementById("noteSubjectTag");
    const unitTitleEl = document.getElementById("noteUnitTitle");
    const hintEl = document.getElementById("hintContent");

    if (breadcrumbEl) {
      breadcrumbEl.textContent = subject.name + " / " + unitTitle;
    }
    if (subjectTagEl) {
      subjectTagEl.textContent = subject.name;
    }
    if (unitTitleEl) {
      unitTitleEl.textContent = unitTitle;
    }
    if (hintEl) {
      hintEl.textContent = "é€™è£¡ä¹‹å¾Œæœƒæ”¾æœ¬å–®å…ƒçš„å°æé»ï¼Œç”±ä½ æä¾›å…§å®¹ã€‚";
    }
  }

  function initNoteNav() {
    const backBtn = document.getElementById("noteBackBtn");
    if (backBtn) {
      backBtn.addEventListener("click", () => {
        if (activeSubjectId) {
          const subject = SUBJECTS[activeSubjectId];
          if (subject) {
            renderBook(subject);
          }
        }
        showView("book");
      });
    }
  }

  // ===== 7. Firebase åˆå§‹åŒ–èˆ‡ç™»å…¥ =====
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_PROJECT_ID.appspot.com",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
  };

  function initFirebaseAndAuth() {
    const userLabel = document.getElementById("authUserLabel");
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");

    if (!window.firebase) {
      if (userLabel) userLabel.textContent = "å°šæœªç™»å…¥ï¼ˆFirebase SDK æœªè¼‰å…¥ï¼‰";
      if (loginBtn) loginBtn.disabled = true;
      return;
    }

    try {
      const placeholder = !firebaseConfig.apiKey || firebaseConfig.apiKey === "YOUR_API_KEY";
      if (placeholder) {
        if (userLabel) userLabel.textContent = "å°šæœªç™»å…¥ï¼ˆè«‹å…ˆåœ¨ç¨‹å¼ä¸­è¨­å®š firebaseConfigï¼‰";
        if (loginBtn) loginBtn.disabled = true;
        return;
      }

      firebase.initializeApp(firebaseConfig);
      auth = firebase.auth();
      db = firebase.firestore();
      firebaseReady = true;
    } catch (e) {
      console.error("Firebase åˆå§‹åŒ–å¤±æ•—ï¼š", e);
      if (userLabel) userLabel.textContent = "å°šæœªç™»å…¥ï¼ˆFirebase åˆå§‹åŒ–å¤±æ•—ï¼‰";
      if (loginBtn) loginBtn.disabled = true;
      return;
    }

    if (loginBtn) {
      loginBtn.addEventListener("click", () => {
        if (!firebaseReady || !auth) {
          alert("å°šæœªè¨­å®šæœ‰æ•ˆçš„ Firebase è¨­å®šï¼Œè«‹å…ˆåœ¨ç¨‹å¼ç¢¼ä¸­å¡«å…¥ firebaseConfigã€‚");
          return;
        }
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider).catch((err) => {
          console.error("ç™»å…¥å¤±æ•—", err);
          alert("ç™»å…¥å¤±æ•—ï¼š" + (err && err.message ? err.message : "è«‹ç¨å¾Œå†è©¦"));
        });
      });
    }

    if (logoutBtn) {
      logoutBtn.addEventListener("click", () => {
        if (!auth) return;
        auth.signOut().catch((err) => {
          console.error("ç™»å‡ºå¤±æ•—", err);
        });
      });
    }

    if (auth) {
      auth.onAuthStateChanged((user) => {
        currentUser = user || null;
        if (userLabel) {
          if (user) {
            userLabel.textContent = "å·²ç™»å…¥ï¼š" + (user.displayName || user.email || "åŒ¿åä½¿ç”¨è€…");
          } else {
            userLabel.textContent = "å°šæœªç™»å…¥";
          }
        }
        if (loginBtn) loginBtn.style.display = user ? "none" : "inline-flex";
        if (logoutBtn) logoutBtn.style.display = user ? "inline-flex" : "none";
        updateNoteEditorState();
        if (currentView === "note" && activeUnitId && firebaseReady && db) {
          loadUserNote();
        }
      });
    }
  }

  // ===== 8. å€‹äººé›²ç«¯ç­†è¨˜ï¼šè¼‰å…¥ / å„²å­˜ =====
  function updateNoteEditorState() {
    const textarea = document.getElementById("noteTextarea");
    const saveBtn = document.getElementById("noteSaveBtn");
    const status = document.getElementById("noteStatusText");

    if (!textarea || !saveBtn || !status) return;

    if (!firebaseReady) {
      textarea.disabled = true;
      saveBtn.disabled = true;
      status.textContent = "Firebase å°šæœªè¨­å®šï¼Œå› æ­¤æš«ä¸æä¾›é›²ç«¯ç­†è¨˜åŠŸèƒ½ã€‚";
      return;
    }

    if (!currentUser) {
      textarea.disabled = true;
      saveBtn.disabled = true;
      status.textContent = "è«‹å…ˆç™»å…¥ä»¥ç·¨è¼¯ä¸¦å„²å­˜ç­†è¨˜ã€‚";
      return;
    }

    textarea.disabled = false;
    saveBtn.disabled = false;
    status.textContent = "å·²ç™»å…¥ï¼Œå¯ä»¥ç·¨è¼¯ç­†è¨˜ä¸¦å„²å­˜åˆ°å€‹äººå¸³è™Ÿã€‚";
  }

  function loadUserNote() {
    const textarea = document.getElementById("noteTextarea");
    const status = document.getElementById("noteStatusText");
    const footerInfo = document.getElementById("noteFooterInfo");

    if (!firebaseReady || !db || !currentUser || !activeUnitId) return;
    if (!textarea || !status) return;

    status.textContent = "è®€å–é›²ç«¯ç­†è¨˜ä¸­...";
    footerInfo.textContent = "";

    const docRef = db.collection("userNotes").doc(currentUser.uid).collection("units").doc(activeUnitId);
    docRef.get().then((doc) => {
      if (doc.exists) {
        const data = doc.data() || {};
        textarea.value = data.noteText || "";
        status.textContent = "å·²å¾é›²ç«¯è¼‰å…¥ç­†è¨˜ã€‚";
        if (data.updatedAt && data.updatedAt.toDate) {
          const d = data.updatedAt.toDate();
          const y = d.getFullYear();
          const m = String(d.getMonth() + 1).padStart(2, "0");
          const dd = String(d.getDate()).padStart(2, "0");
          const hh = String(d.getHours()).padStart(2, "0");
          const mm = String(d.getMinutes()).padStart(2, "0");
          footerInfo.textContent = "ä¸Šæ¬¡å„²å­˜æ™‚é–“ï¼š" + `${y}/${m}/${dd} ${hh}:${mm}`;
        }
      } else {
        textarea.value = "";
        status.textContent = "å°šæœªå»ºç«‹ç­†è¨˜ï¼Œå¯ä»¥é–‹å§‹æ’°å¯«ã€‚";
      }
    }).catch((err) => {
      console.error("è¼‰å…¥ç­†è¨˜å¤±æ•—", err);
      status.textContent = "è¼‰å…¥ç­†è¨˜æ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚";
    });
  }

  function initNoteEditor() {
    const saveBtn = document.getElementById("noteSaveBtn");
    const textarea = document.getElementById("noteTextarea");
    const status = document.getElementById("noteStatusText");
    const footerInfo = document.getElementById("noteFooterInfo");

    if (!saveBtn || !textarea || !status) return;

    saveBtn.addEventListener("click", () => {
      if (!firebaseReady || !db || !auth) {
        alert("Firebase å°šæœªè¨­å®šï¼Œç„¡æ³•å„²å­˜åˆ°é›²ç«¯ã€‚");
        return;
      }
      if (!currentUser) {
        alert("è«‹å…ˆç™»å…¥å†å„²å­˜ç­†è¨˜ã€‚");
        return;
      }
      if (!activeUnitId) {
        alert("ç›®å‰æ²’æœ‰é¸å®šå–®å…ƒã€‚");
        return;
      }

      const noteText = textarea.value || "";
      const docRef = db.collection("userNotes").doc(currentUser.uid).collection("units").doc(activeUnitId);
      saveBtn.disabled = true;
      status.textContent = "å„²å­˜ä¸­...";

      docRef.set({
        noteText: noteText,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        subjectId: activeSubjectId,
        unitTitle: activeUnitTitle
      }, { merge: true }).then(() => {
        status.textContent = "å·²å„²å­˜åˆ°é›²ç«¯ã€‚";
        if (footerInfo) {
          const now = new Date();
          const y = now.getFullYear();
          const m = String(now.getMonth() + 1).padStart(2, "0");
          const d = String(now.getDate()).padStart(2, "0");
          const hh = String(now.getHours()).padStart(2, "0");
          const mm = String(now.getMinutes()).padStart(2, "0");
          footerInfo.textContent = "ä¸Šæ¬¡å„²å­˜æ™‚é–“ï¼š" + `${y}/${m}/${d} ${hh}:${mm}`;
        }
      }).catch((err) => {
        console.error("å„²å­˜ç­†è¨˜å¤±æ•—", err);
        alert("å„²å­˜ç­†è¨˜å¤±æ•—ï¼š" + (err && err.message ? err.message : "è«‹ç¨å¾Œå†è©¦"));
        status.textContent = "å„²å­˜æ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚";
      }).finally(() => {
        saveBtn.disabled = false;
      });
    });
  }

  // ===== 9. DOM æº–å‚™å®Œæˆå¾Œåˆå§‹åŒ– =====
  document.addEventListener("DOMContentLoaded", () => {
    initHome();
    initBookNav();
    initNoteNav();
    initNoteEditor();
    initFirebaseAndAuth();
    showView("home");
  });
</script>
</body>
</html>